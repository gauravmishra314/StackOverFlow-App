<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title th:text="${question.title} + ' - Stack Overflow Clone'">Question Title - Stack Overflow Clone</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">
  <script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>
  <style>
    /* Base styles */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      line-height: 1.5;
      color: #232629;
      background-color: #fff;
    }

    /* Container layout */
    .container {
      max-width: 1264px;
      margin: 0 auto;
      padding: 0 24px;
    }

    .page-container {
      display: grid;
      grid-template-columns: 1fr 3fr;
      gap: 24px;
      margin-top: 50px;
    }

    @media (min-width: 1100px) {
      .page-container {
        grid-template-columns: 164px 1fr 300px;
      }
    }

    /* Header styles */
    .top-bar {
      display: flex;
      align-items: center;
      height: 50px;
      background-color: #f8f9f9;
      border-top: 3px solid #f48024;
      border-bottom: 1px solid #e3e6e8;
      position: fixed;
      width: 100%;
      top: 0;
      z-index: 100;
    }

    .logo {
      padding: 0 8px;
      height: 100%;
      display: flex;
      align-items: center;
    }

    .logo img {
      height: 30px;
    }

    .search-container {
      flex-grow: 1;
      max-width: 700px;
      margin: 0 8px;
    }

    .search-input {
      width: 100%;
      padding: 8px 8px 8px 32px;
      border: 1px solid #babfc4;
      border-radius: 3px;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path fill="%23838C95" d="M12.2 13.6a7 7 0 1 1 1.4-1.4l3.1 3.1a1 1 0 1 1-1.4 1.4l-3.1-3.1zM7 12A5 5 0 1 0 7 2a5 5 0 0 0 0 10z"/></svg>');
      background-position: 8px center;
      background-repeat: no-repeat;
    }

    /* Question header */
    .question-header {
      display: flex;
      flex-direction: column;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 1px solid #e3e6e8;
    }

    .question-header h1 {
      font-size: 27px;
      margin-bottom: 8px;
      font-weight: 400;
      color: #242729;
    }

    .question-metadata {
      display: flex;
      gap: 16px;
      font-size: 13px;
      color: #6a737c;
      margin-bottom: 8px;
    }

    .ask-button {
      margin-left: auto;
    }

    .button {
      background-color: #0a95ff;
      color: white;
      border: 1px solid #0a95ff;
      padding: 8px 10px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 13px;
      text-decoration: none;
    }

    .button:hover {
      background-color: #0074cc;
    }

    /* Question layout */
    .post-layout {
      display: grid;
      grid-template-columns: max-content 1fr;
      gap: 16px;
    }

    /* Vote controls */
    .vote-cell {
      display: flex;
      flex-direction: column;
      align-items: center;
      color: #6a737c;
    }

    .vote-cell button {
      background: none;
      border: none;
      color: #babfc4;
      font-size: 30px;
      cursor: pointer;
      padding: 0;
      margin: 2px 0;
    }

    .vote-cell button:hover {
      color: #838c95;
    }

    .vote-count {
      font-size: 21px;
      color: #6a737c;
      margin: 2px 0;
    }

    .bookmark-button, .history-button {
      font-size: 16px !important;
      margin-top: 8px !important;
    }

    /* Post content */
    .post-text {
      font-size: 15px;
      line-height: 1.5;
      overflow-wrap: break-word;
      margin-bottom: 24px;
    }

    /* Code blocks */
    .post-text pre {
      background-color: #f6f6f6;
      padding: 12px;
      border-radius: 3px;
      overflow-x: auto;
      font-family: Consolas, Monaco, 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.4;
      margin: 16px 0;
    }

    .post-text code {
      background-color: #f6f6f6;
      padding: 2px 5px;
      border-radius: 3px;
      font-family: Consolas, Monaco, 'Courier New', monospace;
      font-size: 13px;
    }

    /* Tags */
    .post-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-bottom: 12px;
    }

    .post-tag {
      background-color: #e1ecf4;
      color: #39739d;
      padding: 4px 6px;
      border-radius: 3px;
      font-size: 12px;
      text-decoration: none;
    }

    .post-tag:hover {
      background-color: #d0e3f1;
      color: #2c5877;
    }

    /* Post actions */
    .post-actions {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      color: #6a737c;
      margin-bottom: 16px;
    }

    .post-menu {
      display: flex;
      gap: 12px;
    }

    .post-menu a {
      color: #6a737c;
      text-decoration: none;
    }

    .post-menu a:hover {
      color: #0074cc;
    }

    /* User card */
    .user-info {
      display: flex;
      align-items: center;
      padding: 5px 6px 7px 7px;
      background-color: #f8f9f9;
      border-radius: 3px;
    }

    .user-action-time {
      color: #6a737c;
      font-size: 12px;
      margin-right: 8px;
    }

    .user-gravatar {
      margin-right: 8px;
    }

    .user-gravatar img {
      width: 32px;
      height: 32px;
      border-radius: 3px;
    }

    .user-details {
      font-size: 12px;
    }

    .user-details a {
      color: #0074cc;
      text-decoration: none;
    }

    .user-reputation {
      font-weight: bold;
      color: #6a737c;
    }

    /* Answers section */
    .answers-header {
      font-size: 19px;
      font-weight: 400;
      margin: 20px 0;
      padding-top: 20px;
      border-top: 1px solid #e3e6e8;
    }

    /* Answer form */
    .post-form h2 {
      font-size: 19px;
      font-weight: 400;
      margin: 20px 0;
      padding-top: 20px;
      border-top: 1px solid #e3e6e8;
    }

    .form-group {
      margin-bottom: 12px;
    }

    .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #babfc4;
      border-radius: 3px;
      font-family: inherit;
      font-size: 15px;
      resize: vertical;
    }

     .content-block {
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            padding: 1rem;
            background-color: white;
        }

        .editor-toolbar {
            border: 1px solid #e2e8f0;
            border-bottom: none;
            border-radius: 0.5rem 0.5rem 0 0;
            background-color: #f8fafc;
            padding: 8px;
        }

        .editor-content {
            border: 1px solid #e2e8f0;
            border-radius: 0 0 0.5rem 0.5rem;
            min-height: 150px;
            padding: 10px;
        }

        .preview-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 0.5rem;
            margin-top: 0.5rem;
        }

        .content-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 8px;
            gap: 0.5rem;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
            width: 100%;
            height: 100%;
        }

        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .loading-spinner {
            display: none;
        }

        .loading .loading-spinner {
            display: inline-block;
        }

    /* Delete modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
      background-color: white;
      margin: 15% auto;
      padding: 20px;
      border-radius: 3px;
      max-width: 400px;
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 16px;
    }

    .danger-button {
      background-color: #d0393e;
      border-color: #d0393e;
    }

    .danger-button:hover {
      background-color: #c23030;
    }

    .secondary-button {
      background-color: #f8f9f9;
      color: #3b4045;
      border-color: #d6d9dc;
    }

    .secondary-button:hover {
      background-color: #e3e6e8;
    }

    .login-prompt {
      margin: 20px 0;
      padding: 16px;
      background-color: #fdf7e3;
      border: 1px solid #e6dcae;
      border-radius: 3px;
    }

    .login-prompt a {
      color: #0074cc;
      text-decoration: none;
    }
    .comment-link {
      margin-right: 8px;
    }

    /* Ensure content renders properly */
    .post-text p {
      margin-bottom: 15px;
    }

    .post-text pre {
      margin: 15px 0;
      padding: 12px;
      background-color: #f6f6f6;
      border-radius: 3px;
      overflow-x: auto;
    }.comment-link {
       margin-right: 8px;
     }

    /* Ensure content renders properly */
    .post-text p {
      margin-bottom: 15px;
    }

    .post-text pre {
      margin: 15px 0;
      padding: 12px;
      background-color: #f6f6f6;
      border-radius: 3px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
<header class="top-bar">
  <div class="logo">
    <img src="https://cdn.sstatic.net/Img/unified/sprites.svg?v=e5e58ae7df45" alt="Stack Overflow">
  </div>
  <div class="search-container">
    <input type="text" placeholder="Search..." class="search-input">
  </div>
  <div class="user-nav">
    <!-- User navigation would go here -->
  </div>
</header>

<div class="container">
  <div class="page-container">
    <!-- Left Sidebar -->
    <div class="left-sidebar">
      <nav>
        <ul style="list-style-type: none;">
          <li><a href="/" style="text-decoration: none; color: #525960; display: flex; align-items: center; padding: 8px;">
            <i class="fas fa-home" style="margin-right: 8px;"></i> Home
          </a></li>
          <li><a href="/questions" style="text-decoration: none; color: #525960; display: flex; align-items: center; padding: 8px; font-weight: bold; background-color: #f1f2f3;">
            <i class="fas fa-question" style="margin-right: 8px;"></i> Questions
          </a></li>
          <li><a href="/tags" style="text-decoration: none; color: #525960; display: flex; align-items: center; padding: 8px;">
            <i class="fas fa-tag" style="margin-right: 8px;"></i> Tags
          </a></li>
        </ul>
      </nav>
    </div>

    <!-- Main Content -->
    <div class="content">
      <div class="question-header">
        <h1 th:text="${question.title}">Question Title</h1>
        <div class="question-metadata">
          <span class="asked">Asked <span th:text="${#temporals.format(question.createdAt, 'MMM d, yyyy')}">Feb 20, 2023</span></span>
          <span class="modified" th:if="${question.updatedAt != question.createdAt}">Modified <span th:text="${#temporals.format(question.updatedAt, 'MMM d, yyyy')}">Feb 20, 2023</span></span>
          <span class="viewed">Viewed <span th:text="${question.viewsCount}">6</span> times</span>
        </div>
        <div class="ask-button">
          <a href="/questions/ask" class="button">Ask Question</a>
        </div>
      </div>

      <!-- Question -->
      <div class="question-body">
        <div class="post-layout">
          <!-- Vote controls -->
          <div class="vote-cell">
            <button class="vote-up-button" th:attr="data-question-id=${question.id}">
              <i class="fas fa-caret-up"></i>
            </button>
            <div class="vote-count" th:text="${question.voteCount}">0</div>
            <button class="vote-down-button" th:attr="data-question-id=${question.id}">
              <i class="fas fa-caret-down"></i>
            </button>
            <button class="bookmark-button" th:attr="data-question-id=${question.id}">
              <i class="far fa-bookmark"></i>
            </button>
            <button class="history-button" th:if="${question.updatedAt != question.createdAt}">
              <i class="fas fa-history"></i>
            </button>
          </div>

          <!-- Question content -->
          <div class="post-cell">
            <!-- Main question image if present -->
            <div class="post-image" th:if="${question.imageURL != null}">
              <img th:src="${question.imageURL}" alt="Question image" style="max-width: 100%; margin-bottom: 16px;">
            </div>

            <!-- Question content -->
            <div class="post-text" th:utext="${question.content}">
              <!-- Content rendered from Markdown -->
              <p>We are using an Azure postgresql flexible server DB for doing our performance testing. On max load of around 50 tps, all our queries are failing with</p>
              <pre><code>Could not execute statement. [Hint: You might need to increase max_pred_locks_per_transaction.] [n/a].</code></pre>
            </div>

            <!-- Tags -->
            <div class="post-tags">
              <a th:each="tag : ${tag}" th:href="@{/tags/{tag}(tag=${tag})}" class="post-tag" th:text="${tag.name}">postgresql</a>
<!--              <a href="/tags/spring-boot" class="post-tag">spring-boot</a>-->
<!--              <a href="/tags/hibernate" class="post-tag">hibernate</a>-->
            </div>

            <!-- Question actions -->
            <div class="post-actions">
              <div class="post-menu">
                <a href="#" class="share-link">Share</a>
                <a href="#" class="comment-link">Add a comment</a>
                <a th:href="@{/questions/edit/{id}(id=${question.id})}" class="edit-link">Edit</a>
                <a href="#" class="follow-link">Follow</a>
<!--                <a href="#" class="delete-question" th:attr="data-question-id=${question.id}">Delete</a>-->

                  <form th:action="@{/questions/delete/{id}(id=${question.id})}" method="post">
                    <input type="hidden" name="_method" value="DELETE" />
                    <button type="submit" class="delete-question">Delete</button>
                </form>
              </div>

              <!-- User card -->
              <div class="user-info" th:if="${question.user != null}">
                <div class="user-action-time">
                  asked <span th:text="${#temporals.format(question.createdAt, 'MMM d, yyyy')}">Feb 20, 2023</span>
                </div>
                <div class="user-gravatar">
                  <a th:href="@{/users/{id}(id=${question.user.id})}">
                    <img th:src="${question.user.avatarUrl ?: '/images/default-avatar.png'}" alt="User avatar">
                  </a>
                </div>
                <div class="user-details">
                  <a th:href="@{/users/{id}(id=${question.user.id})}" th:text="${question.user.displayName}">Username</a>
                  <div class="user-reputation" th:text="${question.user.reputation}">123</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Answer count -->
      <h2 class="answers-header">
        <span th:text="${question.answerCount}">0</span> Answers
      </h2>

      <!-- Answers would be here -->
      <div id="answers">
        <!-- This would be populated dynamically or from a fragment -->
      </div>

      <!-- Answer form -->
      <div class="post-form">
        <h2>Your Answer</h2>
<!--        <form th:action="@{/answers/{questionId}(questionId=${question.id})}" method="post">-->
<!--          <div class="form-group">-->
<!--            <textarea id="answer-content" name="content" rows="10"-->
<!--                      placeholder="Write your answer here. Support Markdown formatting."></textarea>-->
<!--          </div>-->
<!--          <button type="submit" class="button">Post Your Answer</button>-->
<!--        </form>-->

        <div class="container mx-auto px-4 py-8 max-w-4xl">
          <form id="contentForm" class="space-y-6">
            <div class="bg-white p-6 rounded-lg border border-gray-200">
              <!-- Content blocks container -->
              <div id="contentBlocks">
                <!-- First content block (text) - Always required -->
                <div class="content-block" data-type="text" data-block-id="0">
                  <label class="block font-bold mb-2">Content</label>
                  <p class="text-gray-600 text-sm mb-2">Provide details of your content. Minimum 20 characters.</p>
                  <div class="editor-toolbar flex gap-2">
                    <button type="button" class="p-1 hover:bg-gray-200 rounded" data-action="bold">B</button>
                    <button type="button" class="p-1 hover:bg-gray-200 rounded" data-action="italic">I</button>
                    <button type="button" class="p-1 hover:bg-gray-200 rounded" data-action="code">{}</button>
                    <button type="button" class="p-1 hover:bg-gray-200 rounded" data-action="link">🔗</button>
                  </div>
                  <textarea name="contentBlocks[0].text" class="editor-content w-full" required></textarea>
                  <input type="hidden" name="contentBlocks[0].type" value="text">
                  <div class="content-actions">
                    <button type="button" class="bg-gray-200 text-gray-700 px-3 py-1 rounded-md text-sm add-image-btn">Add Image</button>
                    <button type="button" class="bg-gray-200 text-gray-700 px-3 py-1 rounded-md text-sm add-text-btn">Add Text</button>
                  </div>
                </div>
              </div>
            </div>
            <div class="flex justify-end">
              <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-md">Submit Content</button>
            </div>
          </form>
        </div>

        <!-- Template for new text block -->
        <template id="textBlockTemplate">
          <div class="content-block" data-type="text">
            <label class="block font-bold mb-2">Additional Text</label>
            <div class="editor-toolbar flex gap-2">
              <button type="button" class="p-1 hover:bg-gray-200 rounded" data-action="bold">B</button>
              <button type="button" class="p-1 hover:bg-gray-200 rounded" data-action="italic">I</button>
              <button type="button" class="p-1 hover:bg-gray-200 rounded" data-action="code">{}</button>
              <button type="button" class="p-1 hover:bg-gray-200 rounded" data-action="link">🔗</button>
            </div>
            <textarea class="editor-content w-full"></textarea>
            <input type="hidden" value="text">
            <div class="content-actions">
              <button type="button" class="bg-red-100 text-red-700 px-3 py-1 rounded-md text-sm delete-block-btn">Delete</button>
              <button type="button" class="bg-gray-200 text-gray-700 px-3 py-1 rounded-md text-sm add-image-btn">Add Image</button>
              <button type="button" class="bg-gray-200 text-gray-700 px-3 py-1 rounded-md text-sm add-text-btn">Add Text</button>
            </div>
          </div>
        </template>

        <!-- Template for new image block -->
        <template id="imageBlockTemplate">
          <div class="content-block" data-type="image">
            <label class="block font-bold mb-2">Image Content</label>
            <p class="text-gray-600 text-sm mb-2">Upload an image</p>

            <div class="flex items-center space-x-4">
              <div class="file-input-wrapper">
                <button type="button" class="bg-blue-50 text-blue-600 px-4 py-2 rounded-md border border-blue-200">
                  Choose File
                </button>
                <input type="file" accept="image/*" class="block-image-input cursor-pointer">
              </div>
              <span class="file-name-display text-sm text-gray-600">No file selected</span>
            </div>

            <div class="block-preview-container mt-4 hidden">
              <img src="#" alt="Image preview" class="preview-image block-image-preview">
            </div>

            <input type="hidden" value="image">
            <div class="content-actions">
              <button type="button" class="bg-red-100 text-red-700 px-3 py-1 rounded-md text-sm delete-block-btn">Delete</button>
              <button type="button" class="bg-gray-200 text-gray-700 px-3 py-1 rounded-md text-sm add-image-btn">Add Image</button>
              <button type="button" class="bg-gray-200 text-gray-700 px-3 py-1 rounded-md text-sm add-text-btn">Add Text</button>
            </div>
          </div>
        </template>

        <!-- Login prompt if not authenticated -->
        <div class="login-prompt" style="display: none;">
          <p>You must <a th:href="@{/login}">log in</a> to answer this question.</p>
        </div>
      </div>
    </div>

    <!-- Right Sidebar -->
    <div class="right-sidebar">
      <div style="background-color: #fdf7e3; padding: 16px; border-radius: 3px; margin-bottom: 16px;">
        <h3 style="font-size: 15px; margin-bottom: 8px;">The Overflow Blog</h3>
        <ul style="list-style-type: none; margin-left: 20px;">
          <li style="display: flex; margin-bottom: 8px;">
            <i class="fas fa-pencil-alt" style="margin-right: 8px; margin-left: -20px;"></i>
            <a href="#" style="color: #3b4045; text-decoration: none; font-size: 13px;">Why is it so hard for companies to protect your privacy?</a>
          </li>
        </ul>

        <h3 style="font-size: 15px; margin: 16px 0 8px 0;">Featured on Meta</h3>
        <ul style="list-style-type: none; margin-left: 20px;">
          <li style="display: flex; margin-bottom: 8px;">
            <i class="fab fa-stack-overflow" style="color: #0086d8; margin-right: 8px; margin-left: -20px;"></i>
            <a href="#" style="color: #3b4045; text-decoration: none; font-size: 13px;">Join us for our first community-wide AMA</a>
          </li>
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- Delete confirmation modal -->
<div id="delete-modal" class="modal">
  <div class="modal-content">
    <h3>Delete Question</h3>
    <p>Are you sure you want to delete this question? This action cannot be undone.</p>
    <div class="modal-actions">
      <button id="confirm-delete" class="button danger-button">Delete</button>
      <button id="cancel-delete" class="button secondary-button">Cancel</button>
    </div>
  </div>
</div>
<script>
  // Initialize variables
  let blockCounter = 1;
  let editors = [];

  document.addEventListener('DOMContentLoaded', function() {
      // Initialize the first editor
      setupEditor(document.querySelector('.editor-content'));

      // Setup event listeners
      setupEventListeners();

      // Setup main image preview
      setupMainImagePreview();

      // Add demo content
      setTimeout(() => {
          // Add a text block for demo
          const firstBlock = document.querySelector('.content-block');
          addTextBlock(firstBlock);

          // Add an image block for demo
          const secondBlock = document.querySelectorAll('.content-block')[1];
          addImageBlock(secondBlock);

          // Add some sample text to first editor
          if (editors[0]) {
              editors[0].value("# Sample Content\n\nThis is an example of the content editor with image upload functionality. You can add multiple blocks of text and images.\n\n- You can format text\n- Upload images\n- Rearrange content");
          }

          // Show main image preview for demo
          const demoImage = document.getElementById('imagePreview');
          demoImage.src = "/api/placeholder/400/300";
          document.getElementById('fileNameDisplay').textContent = "example-image.jpg";
          document.getElementById('imagePreviewContainer').classList.remove('hidden');

          // Show an image in the image block for demo
          const blockPreview = document.querySelector('.block-image-preview');
          if (blockPreview) {
              blockPreview.src = "/api/placeholder/400/250";
              blockPreview.closest('.block-preview-container').classList.remove('hidden');
              const fileDisplay = blockPreview.closest('.content-block').querySelector('.file-name-display');
              if (fileDisplay) {
                  fileDisplay.textContent = "second-image.png";
              }
          }
      }, 500);
  });

  function setupEditor(textareaElement) {
      const editor = new SimpleMDE({
          element: textareaElement,
          spellChecker: false,
          status: false,
          toolbar: false,
          placeholder: "Enter your content here..."
      });
      editors.push(editor);
      return editor;
  }

  function setupEventListeners() {
      // Add event listeners for block actions using event delegation
      document.addEventListener('click', function(e) {
          // Add text block
          if (e.target.classList.contains('add-text-btn')) {
              addTextBlock(e.target.closest('.content-block'));
          }
          // Add image block
          else if (e.target.classList.contains('add-image-btn')) {
              addImageBlock(e.target.closest('.content-block'));
          }
          // Delete block
          else if (e.target.classList.contains('delete-block-btn')) {
              deleteBlock(e.target.closest('.content-block'));
          }
          // Editor toolbar buttons
          else if (e.target.closest('.editor-toolbar')) {
              const button = e.target.closest('button');
              if (button) {
                  const action = button.dataset.action;
                  const contentBlock = button.closest('.content-block');
                  const blockId = contentBlock.dataset.blockId;

                  if (action && typeof blockId !== 'undefined') {
                      handleEditorAction(action, parseInt(blockId));
                  }
              }
          }
      });

      // Form submission
      document.getElementById('contentForm').addEventListener('submit', function(e) {
          e.preventDefault();
          prepareContentData();

          // Here you would typically send the form data to your server
          console.log('Form submitted!');

          // For demo purposes, show what was submitted
          const formData = new FormData(e.target);
          for (let [key, value] of formData.entries()) {
              if (typeof value !== 'object') { // Skip file objects for console output
                  console.log(`${key}: ${value}`);
              } else {
                  console.log(`${key}: [File object]`);
              }
          }

          alert('Content submitted successfully!');
      });
  }

  function setupMainImagePreview() {
      const mainImageInput = document.getElementById('mainImage');
      const fileNameDisplay = document.getElementById('fileNameDisplay');
      const imagePreview = document.getElementById('imagePreview');
      const imagePreviewContainer = document.getElementById('imagePreviewContainer');
      const removeImageBtn = document.getElementById('removeImage');

      mainImageInput.addEventListener('change', function() {
          if (this.files && this.files[0]) {
              const file = this.files[0];
              fileNameDisplay.textContent = file.name;

              const reader = new FileReader();
              reader.onload = function(e) {
                  imagePreview.src = e.target.result;
                  imagePreviewContainer.classList.remove('hidden');
              }
              reader.readAsDataURL(file);
          } else {
              fileNameDisplay.textContent = 'No file selected';
              imagePreviewContainer.classList.add('hidden');
          }
      });

      removeImageBtn.addEventListener('click', function() {
          mainImageInput.value = '';
          fileNameDisplay.textContent = 'No file selected';
          imagePreviewContainer.classList.add('hidden');
      });
  }

  function setupBlockImagePreview(block) {
      const imageInput = block.querySelector('.block-image-input');
      const fileNameDisplay = block.querySelector('.file-name-display');
      const imagePreview = block.querySelector('.block-image-preview');
      const previewContainer = block.querySelector('.block-preview-container');

      imageInput.addEventListener('change', function() {
          if (this.files && this.files[0]) {
              const file = this.files[0];
              fileNameDisplay.textContent = file.name;

              const reader = new FileReader();
              reader.onload = function(e) {
                  imagePreview.src = e.target.result;
                  previewContainer.classList.remove('hidden');
              }
              reader.readAsDataURL(file);
          } else {
              fileNameDisplay.textContent = 'No file selected';
              previewContainer.classList.add('hidden');
          }
      });
  }

  function addTextBlock(currentBlock) {
      const template = document.getElementById('textBlockTemplate');
      const newBlock = template.content.cloneNode(true).firstElementChild;
      newBlock.dataset.blockId = blockCounter;

      // Update name attributes
      newBlock.querySelector('textarea').name = `contentBlocks[${blockCounter}].text`;
      newBlock.querySelector('input[type="hidden"]').name = `contentBlocks[${blockCounter}].type`;

      currentBlock.insertAdjacentElement('afterend', newBlock);

      // Setup editor for the new block
      setupEditor(newBlock.querySelector('textarea'));

      blockCounter++;
  }

  function addImageBlock(currentBlock) {
      const template = document.getElementById('imageBlockTemplate');
      const newBlock = template.content.cloneNode(true).firstElementChild;
      newBlock.dataset.blockId = blockCounter;

      // Update name attributes
      newBlock.querySelector('.block-image-input').name = `contentBlocks[${blockCounter}].image`;
      newBlock.querySelector('input[type="hidden"]').name = `contentBlocks[${blockCounter}].type`;

      currentBlock.insertAdjacentElement('afterend', newBlock);

      // Setup image preview for the new block
      setupBlockImagePreview(newBlock);

      blockCounter++;
  }

  function deleteBlock(blockToDelete) {
      const allBlocks = document.querySelectorAll('.content-block');
      if (allBlocks.length > 1) {
          // Remove editor from editors array if it's a text block
          if (blockToDelete.dataset.type === 'text') {
              const blockId = parseInt(blockToDelete.dataset.blockId);
              if (!isNaN(blockId)) {
                  editors[blockId] = null; // Remove the reference
              }
          }

          blockToDelete.remove();
      } else {
          alert("You must have at least one content block.");
      }
  }

  function handleEditorAction(action, editorIndex) {
      if (editors[editorIndex]) {
          const editor = editors[editorIndex];

          switch(action) {
              case 'bold':
                  editor.codemirror.replaceSelection(`**${editor.codemirror.getSelection() || 'bold text'}**`);
                  break;
              case 'italic':
                  editor.codemirror.replaceSelection(`*${editor.codemirror.getSelection() || 'italic text'}*`);
                  break;
              case 'code':
                  editor.codemirror.replaceSelection(`\`${editor.codemirror.getSelection() || 'code'}\``);
                  break;
              case 'link':
                  const selectedText = editor.codemirror.getSelection() || 'link text';
                  editor.codemirror.replaceSelection(`[${selectedText}](https://example.com)`);
                  break;
          }
      }
  }

  function prepareContentData() {
      // For more complex processing, you'd format data for submission here
      // For now, we'll just update the editor values to ensure they're in sync
      editors.forEach((editor, index) => {
          if (editor !== null) {
              const textarea = editor.codemirror.getTextArea();
              textarea.value = editor.value();
          }
      });

      // Here you could combine all blocks into a single content field if needed
      const contentBlocks = document.querySelectorAll('.content-block');
      let fullContent = '';

      contentBlocks.forEach((block, index) => {
          if (block.dataset.type === 'text') {
              const blockId = parseInt(block.dataset.blockId);
              if (!isNaN(blockId) && editors[blockId]) {
                  const textContent = editors[blockId].value();
                  fullContent += textContent + '\n\n';
              }
          } else if (block.dataset.type === 'image') {
              fullContent += `[IMAGE_PLACEHOLDER_${index}]\n\n`;
          }
      });

      // For debugging
      console.log("Full combined content:", fullContent);

      // You could add a hidden field with the full content if needed:
      // const hiddenContent = document.createElement('input');
      // hiddenContent.type = 'hidden';
      // hiddenContent.name = 'fullContent';
      // hiddenContent.value = fullContent;
      // document.getElementById('contentForm').appendChild(hiddenContent);
  }
</script>
</body>
</html>